<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notas de Pedido</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body class="p-4">
    <div class="container">
        <h1 class="mb-4">Notas de Pedido</h1>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Cliente</th>
                    <th>Teléfono</th>
                    <th>Vendedor</th>
                    <th>Fecha</th>
                    <th>Total</th>
                    <th>PDF</th>
                </tr>
            </thead>
            <tbody id="notas-list">
                <tr><td colspan="6" class="text-center">Cargando...</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        const API_URL = 'https://generadodenotadepedido.onrender.com'; // Ajusta tu backend URL

        async function cargarNotas() {
            const tbody = document.getElementById('notas-list');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">Cargando...</td></tr>';
            try {
                const response = await fetch(`${API_URL}/notas`);
                if (!response.ok) throw new Error('Error al obtener las notas del servidor.');

                const notas = await response.json();
                if (!Array.isArray(notas) || !notas.length) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">No hay notas disponibles</td></tr>';
                    return;
                }

                tbody.innerHTML = '';
                notas.forEach(nota => {
                    const fecha = nota.fecha 
                        ? new Date(nota.fecha).toLocaleDateString('es-AR') 
                        : 'Sin fecha';
                    const telefono = nota.telefono || 'Sin teléfono';
                    const vendedor = nota.vendedor || 'N/A';
                    const total = nota.total ? `$${parseFloat(nota.total).toFixed(2)}` : '$0.00';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${nota.cliente || 'Sin cliente'}</td>
                        <td>${telefono}</td>
                        <td>${vendedor}</td>
                        <td>${fecha}</td>
                        <td>${total}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="generarPDF()">Ver PDF</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error cargando notas:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error cargando notas</td></tr>';
            }
        }

        async function generarPDF() {
    if (!validarCampos()) return;

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const codigoNota = generarCodigoUnico();
    const datos = obtenerDatosFormulario();

    // Aseguramos cliente por defecto si está vacío
    if (!datos.seniores || datos.seniores.trim() === "") {
        datos.seniores = "Sin cliente";
    }

    // Dibujamos el PDF
    dibujarPDF(doc, datos, codigoNota);

    // Guardar en disco
    doc.save(`nota_pedido_${codigoNota}.pdf`);

    // Guardar en backend
    try {
        const pdfBlob = doc.output('blob');
        console.log("Cliente:", datos.seniores);
        console.log("Código de Nota:", codigoNota);

        const formData = prepararFormData(datos, pdfBlob, codigoNota);
        formData.append("codigoNota", codigoNota); // <-- NUEVO

        const response = await fetch(`${API_URL}/notas`, { method: "POST", body: formData });

        if (!response.ok) {
            const errorText = await response.text();
            console.error("Respuesta del backend:", errorText);
            throw new Error("Error al guardar la nota");
        }

        Swal.fire({ icon: "success", title: "¡Guardada!", text: "La nota fue guardada.", confirmButtonText: "OK" });
    } catch (err) {
        console.error("Error enviando nota al backend:", err);
        Swal.fire({ icon: "error", title: "Error", text: "No se pudo guardar la nota.", confirmButtonText: "OK" });
    }
}

// ------------------- OBTENER DATOS DEL FORMULARIO -------------------
function obtenerDatosFormulario() {
    const productos = [];
    const filas = document.querySelectorAll('#detalles .row');

    filas.forEach(fila => {
        const productoSelect = fila.querySelector('.producto-select');
        const inputCustom = fila.querySelector('.input-personalizado')?.value.trim();
        const detalleCustom = fila.querySelector('.detalle-personalizado')?.value.trim();

        let baseProducto = (productoSelect.value === 'custom' || inputCustom) 
            ? (inputCustom || "Producto sin nombre") 
            : productoSelect.options[productoSelect.selectedIndex]?.text || "Sin producto";

        let textoProducto = detalleCustom ? `${baseProducto} - ${detalleCustom}` : baseProducto;

        const cantidad = parseFloat(fila.querySelector('.cantidad').value) || 0;
        const precio = parseFloat(fila.querySelector('.precio').value) || 0;
        productos.push({ detalle: textoProducto, cantidad, precioUnitario: precio, subtotal: cantidad * precio });
    });

    return {
        fecha: document.getElementById('fecha').value,
        fechaEntrega: document.getElementById('fechaEntrega').value,
        seniores: document.getElementById('seniores').value || "Sin cliente", // <--- por defecto
        telefono: document.getElementById('telefono').value,
        vendedor: document.getElementById('vendedor').value,
        transferidoA: document.getElementById('transferidoA').value,
        tipoPago: document.getElementById('tipoPago').value,
        total: parseFloat(document.getElementById('total').value) || 0,
        descuento: parseFloat(document.getElementById('descuento').value) || 0,
        adelanto: parseFloat(document.getElementById('adelanto').value) || 0,
        resta: parseFloat(document.getElementById('resta').value) || 0,
        productos
    };
}

function generarCodigoUnico() {
    const hoy = new Date();
    const fecha = hoy.getFullYear().toString() +
                  String(hoy.getMonth() + 1).padStart(2, '0') +
                  String(hoy.getDate()).padStart(2, '0');
    let contador = parseInt(localStorage.getItem('contador_' + fecha) || '0') + 1;
    localStorage.setItem('contador_' + fecha, contador);
    return `${fecha}-${contador}`;
}

    
    </script>

    
    
</body>
</html>
