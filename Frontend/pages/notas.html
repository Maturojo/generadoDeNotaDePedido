<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notas de Pedido</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body class="p-4">
    <div class="container">
        <h1 class="mb-4">Notas de Pedido</h1>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Cliente</th>
                    <th>Teléfono</th>
                    <th>Vendedor</th>
                    <th>Fecha</th>
                    <th>Total</th>
                    <th>PDF</th>
                </tr>
            </thead>
            <tbody id="notas-list">
                <tr><td colspan="6" class="text-center">Cargando...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- Librería jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        const API_URL = 'https://generadodenotadepedido.onrender.com';
        let logo = null;

        // Cargar logo para el PDF
        const img = new Image();
        img.src = '/assets/logo-linea-gris.png';
        img.onload = function () {
            logo = img;
        };

        // ----------------- CARGAR NOTAS -----------------
        async function cargarNotas() {
            const tbody = document.getElementById('notas-list');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">Cargando...</td></tr>';

            try {
                const response = await fetch(`${API_URL}/notas`);
                if (!response.ok) throw new Error('Error al obtener las notas del servidor.');

                const notas = await response.json();
                if (!Array.isArray(notas) || !notas.length) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">No hay notas disponibles</td></tr>';
                    return;
                }

                tbody.innerHTML = '';
                notas.forEach(nota => {
                    const fecha = nota.fecha 
                        ? new Date(nota.fecha).toLocaleDateString('es-AR') 
                        : 'Sin fecha';
                    const telefono = nota.telefono || 'Sin teléfono';
                    const vendedor = nota.vendedor || 'N/A';
                    const total = nota.total ? `$${parseFloat(nota.total).toFixed(2)}` : '$0.00';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${nota.cliente || 'Sin cliente'}</td>
                        <td>${telefono}</td>
                        <td>${vendedor}</td>
                        <td>${fecha}</td>
                        <td>${total}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick='generarPDFDesdeNota(${JSON.stringify(nota)})'>Ver PDF</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error cargando notas:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error cargando notas</td></tr>';
            }
        }

        // ----------------- GENERAR PDF DESDE NOTA -----------------
        function generarPDFDesdeNota(nota) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const codigoNota = nota.codigoNota || (nota._id || 'SIN-CODIGO');

            doc.setFontSize(16);
            doc.setTextColor(97, 95, 95);
            doc.text("NOTA DE PEDIDO", 60, 25);
            doc.setFontSize(12);
            doc.text("SUR MADERAS", 60, 32);
            doc.setFontSize(11);
            doc.text(`Código: ${codigoNota}`, 60, 39);

            doc.setFontSize(10);
            doc.text(`Fecha: ${nota.fecha ? new Date(nota.fecha).toLocaleDateString('es-AR') : ''}`, 20, 50);
            doc.text(`Entrega: ${nota.fechaEntrega || ''}`, 120, 50);
            doc.text(`Señores: ${nota.cliente || 'Sin cliente'}`, 20, 58);
            doc.text(`Teléfono: ${nota.telefono || ''}`, 20, 66);
            doc.text(`Vendedor: ${nota.vendedor || ''}`, 20, 74);
            doc.text(`Medio de pago: ${nota.transferidoA || ''}`, 20, 82);
            doc.text(`Tipo de pago: ${nota.estado || ''}`, 20, 90);

            // Tabla de productos
            let yTabla = 110;
            doc.rect(20, yTabla, 170, 10);
            doc.line(40, yTabla, 40, yTabla + 10);
            doc.line(150, yTabla, 150, yTabla + 10);
            doc.text("CANT.", 22, yTabla + 7);
            doc.text("DETALLE", 60, yTabla + 7);
            doc.text("IMPORTE", 185, yTabla + 7, { align: 'right' });
            yTabla += 10;

            if (nota.productos && Array.isArray(nota.productos)) {
                nota.productos.forEach(prod => {
                    const detalleTexto = doc.splitTextToSize(prod.detalle, 105);
                    const alturaFila = Math.max(detalleTexto.length * 5, 10);

                    doc.rect(20, yTabla, 170, alturaFila);
                    doc.line(40, yTabla, 40, yTabla + alturaFila);
                    doc.line(150, yTabla, 150, yTabla + alturaFila);

                    doc.text(String(prod.cantidad || 0), 30, yTabla + 6);
                    doc.text(detalleTexto, 45, yTabla + 6);
                    doc.text(`$ ${(prod.subtotal || 0).toFixed(2)}`, 188, yTabla + 6, { align: 'right' });

                    yTabla += alturaFila;
                });
            }

            let yTotales = yTabla + 5;
            if (nota.descuento && nota.descuento > 0) {
                doc.text(`Descuento: $${parseFloat(nota.descuento).toFixed(2)}`, 150, yTotales);
                yTotales += 10;
            }

            doc.text(`TOTAL: $${parseFloat(nota.total || 0).toFixed(2)}`, 150, yTotales);
            if (nota.estado !== "Pago completo") {
                yTotales += 10;
                doc.text(`RESTA: $${parseFloat(nota.resta || 0).toFixed(2)}`, 150, yTotales);
                doc.text(`ADELANTO: $${parseFloat(nota.adelanto || 0).toFixed(2)}`, 150, yTotales);
            }

            if (logo) doc.addImage(logo, 'PNG', 15, 15, 25, 25);

            if (nota.estado === "Pago completo") {
                doc.setFontSize(30);
                doc.setTextColor(0, 0, 0);
                doc.setFont("helvetica", "bold");
                doc.text("PAGADO", 105, 100, { align: "center" });
            }

            doc.save(`nota_pedido_${codigoNota}.pdf`);
        }

        cargarNotas();
    </script>
</body>
</html>
